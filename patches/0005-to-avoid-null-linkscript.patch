From 8e4e88328d77cc8bce423ddbaa0ef3c09e6b34d3 Mon Sep 17 00:00:00 2001
From: KunYi Chen <kunyi.chen@gmail.com>
Date: Thu, 17 Nov 2022 17:50:25 +0800
Subject: [PATCH 5/5] to avoid null linkscript

---
 meta-ma35d1/recipes-bsp/m4proj/m4proj_0.90.bb | 51 +++++++++++++++++--
 1 file changed, 46 insertions(+), 5 deletions(-)

diff --git a/meta-ma35d1/recipes-bsp/m4proj/m4proj_0.90.bb b/meta-ma35d1/recipes-bsp/m4proj/m4proj_0.90.bb
index b690375..881afc7 100644
--- a/meta-ma35d1/recipes-bsp/m4proj/m4proj_0.90.bb
+++ b/meta-ma35d1/recipes-bsp/m4proj/m4proj_0.90.bb
@@ -15,11 +15,50 @@ PV = "M4-BSP"
 S = "${WORKDIR}/git"
 B =  "${WORKDIR}/build"
 
-export CROSS_COMPILE = "${RECIPE_SYSROOT_NATIVE}/${datadir}/gcc-arm-none-eabi/bin/arm-none-eabi-"
-export GCC_PATH = "${RECIPE_SYSROOT_NATIVE}/${datadir}/gcc-arm-none-eabi/bin"
-export NUECLIPSE = "${RECIPE_SYSROOT_NATIVE}/${datadir}/nu-eclipse"
+DEPENDS += "sed-native"
+
+export CROSS_COMPILE = "${RECIPE_SYSROOT_NATIVE}${datadir}/gcc-arm-none-eabi/bin/arm-none-eabi-"
+export GCC_PATH = "${RECIPE_SYSROOT_NATIVE}${datadir}/gcc-arm-none-eabi/bin"
+export NUECLIPSE = "${RECIPE_SYSROOT_NATIVE}${datadir}/nu-eclipse"
 export DISPLAY= ":99"
 
+python do_patch() {
+    import os
+    import subprocess
+    import shutil
+    import fnmatch
+    f = open('patch_log.txt', "w+")
+    root = os.getcwd()
+    os.chdir(d.getVar('S',1))
+    f.write("root="+root+"\n")
+    f.write("S="+d.getVar('S',1)+"\n")
+
+    oldld = d.getVar('S', 1) + "/Library/Device/Nuvoton/ma35d1_rtp/Source/GCC/gcc_arm.ld"
+    patchld = d.getVar('S', 1) + "/gcc_arm.ld"
+
+    f.write("original linker script="+ oldld + "\n")
+    f.write("patch linker script=" + patchld + "\n")
+    f.write("\n======= m480-bsp =======\n")
+    # patch linkscript
+    cmd = "sed 's/.*KEEP(\*(.vectors)).*/\\t\\t__Vectors = .;\\n&/g' " + oldld + " > " + patchld + "\n"
+    f.write("cmd="+cmd+"\n")
+    f.flush()
+    retcode = subprocess.call(cmd,shell=True,stdout=f)
+
+    # replace linkscript file
+    for dirPath, dirNames, fileNames in os.walk("SampleCode"):
+        for file in fnmatch.filter(fileNames, '*.cproject'):
+            if not os.path.isdir(dirPath+"/Release"):
+                f.write("dirPath="+dirPath+"\n")
+                cmd = "sed -i 's|${workspace_loc:/${ProjName}/CMSIS/CMSIS/GCC/gcc_arm.ld}|" + patchld + "|g' " + \
+                d.getVar('S', 1) + "/" + dirPath + "/.cproject \n"
+                f.write("cmd="+cmd+"\n")
+                f.flush()
+                retcode = subprocess.call(cmd,shell=True,stdout=f)
+    os.chdir(root)
+    f.close()
+}
+
 python do_compile() {
     import os
     import subprocess
@@ -42,7 +81,9 @@ python do_compile() {
                 else:
                     shutil.rmtree("Temp")
                     os.mkdir("Temp")
-                cmd = d.getVar('NUECLIPSE',1)+"/eclipse/eclipse -nosplash --launcher.suppressErrors -application org.eclipse.cdt.managedbuilder.core.headlessbuild -data Temp -cleanBuild all -import "+dirPath + "\n"
+
+                cmd = d.getVar('NUECLIPSE',1)+"/eclipse/eclipse -nosplash --launcher.suppressErrors -application org.eclipse.cdt.managedbuilder.core.headlessbuild " + \
+                        "-data Temp -cleanBuild all -import " + dirPath + "\n"
                 f.write("cmd="+cmd+"\n")
                 f.flush()
                 retcode = subprocess.call(cmd,shell=True,stdout=f)
@@ -84,7 +125,7 @@ python do_install() {
 
 do_deploy() {
     install -d ${DEPLOYDIR}/${BOOT_TOOLS}/m4proj
-    cp -rf ${D}/${exec_prefix}/m4proj/* ${DEPLOYDIR}/${BOOT_TOOLS}/m4proj/
+    cp -rf ${D}${exec_prefix}/m4proj/* ${DEPLOYDIR}/${BOOT_TOOLS}/m4proj/
 }
 
 INSANE_SKIP_${PN} = "arch"
-- 
2.38.1

